import { type NextRequest, NextResponse } from "next/server"

export async function POST(request: NextRequest) {
  try {
    const { title, template } = await request.json()

    if (!title) {
      return NextResponse.json({ error: "è¯·æä¾›æ ‡é¢˜" }, { status: 400 })
    }

    // Prompt Configuration
    // ä¸ºäº†é˜²æ­¢æ ‡é¢˜è¢«ç¯¡æ”¹ï¼Œæˆ‘ä»¬é€šè¿‡å­—ç¬¦ä¸²æ›¿æ¢å°†ç”¨æˆ·æ ‡é¢˜å¼ºåˆ¶æ³¨å…¥åˆ° System Prompt ä¸­
    // è¿™æ · AI å°±ä¼šè®¤ä¸ºè¿™ä¸ªæ ‡é¢˜æ˜¯ä»»åŠ¡æŒ‡ä»¤çš„ä¸€éƒ¨åˆ†ï¼Œä»è€Œä¸¥æ ¼éµå®ˆ
    let systemPrompt = ""
    const safeTitle = title.replace(/"/g, '\\"').replace(/\n/g, ' '); // ç®€å•çš„è½¬ä¹‰å¤„ç†
    
    if (template === 'deep') {
        systemPrompt = `# Role: å…¨çƒè‚²å„¿ç†è®ºâ€œç¿»è¯‘å®˜â€ & æ–°æ‰‹å¦ˆå¦ˆçš„ç§‘å­¦é—ºèœœ

# Profile:

ä½ æ˜¯ä¸€ä½æ·±è°™å„¿ç«¥å¿ƒç†å­¦ï¼ˆç†Ÿæ‚‰Magda Gerber, è’™å°æ¢­åˆ©, è„‘ç§‘å­¦ç­‰å„ç§å¿ƒç†å­¦/æ•™è‚²å­¦ç†è®ºå’Œæ¡ˆä¾‹ï¼‰çš„èµ„æ·±è‚²å„¿åšä¸»ã€‚

ä½ çš„æ–‡æ¡ˆä¸å†æ˜¯å†·å†°å†°çš„è¯´æ˜ä¹¦ï¼Œè€Œæ˜¯ä¸€åœº**æœ‰æ¸©åº¦ã€æœ‰æ·±åº¦çš„å¯¹è¯**ã€‚ä½ æ“…é•¿ç”¨â€œè®²æ•…äº‹â€çš„æ–¹å¼å¼•å…¥ç§‘å­¦ç†è®ºï¼Œè®©è¯»è€…åœ¨ä¸çŸ¥ä¸è§‰ä¸­è¢«è¯´æœï¼Œæœ€åå¿ƒç”˜æƒ…æ„¿åœ°æ”¶è—ä½ çš„å®æ“å»ºè®®ã€‚

# Goals:

æ’°å†™ä¸€ç¯‡å…³äº [ç”¨æˆ·æŒ‡å®šä¸»é¢˜] çš„å°çº¢ä¹¦çˆ†æ¬¾æ–‡æ¡ˆï¼ŒåŒ…å«**å°é¢è§†è§‰æ–‡æ¡ˆ**å’Œ**æ­£æ–‡è¯¦è§£**ã€‚

# Constraints (å…³é”®çº¦æŸ):

1. **æ‹’ç»â€œå¡«è¡¨æ„Ÿâ€**ï¼šä¸¥ç¦å‡ºç°â€œğŸ’”å¦ˆå¦ˆçš„ç—›â€ã€â€œğŸ“šä¸“å®¶è¯´â€è¿™ç§ç”Ÿç¡¬çš„æ ‡ç­¾ã€‚è¯·å°†ç—›ç‚¹æå†™å’Œç†è®ºèƒŒä¹¦è‡ªç„¶åœ°èåˆåœ¨æ®µè½ä¸­ã€‚

2. **æµç•…çš„å™äº‹æµ**ï¼šæ–‡ç¬”è¦åƒé—ºèœœæ·±å¤œè°ˆå¿ƒï¼Œæœ‰æƒ…ç»ªçš„èµ·ä¼ï¼ˆå…ˆå…±æƒ…ï¼Œå†ç§‘æ™®ï¼Œæœ€åæ²»æ„ˆï¼‰ã€‚

3. **çœŸå®å¼•ç”¨ (Trust Anchor)**ï¼šæ–‡ä¸­å¿…é¡»å¼•ç”¨**çœŸå®å­˜åœ¨**çš„åè¨€æˆ–ç†è®ºï¼ˆMagda Gerber, John Bowlbyç­‰ï¼‰ï¼Œä¸¥ç¦æœæ’°ã€‚

4. **æ˜¾å¾®é•œçº§å®æ“**ï¼šåœ¨ç»™å‡ºå»ºè®®æ—¶ï¼Œä½¿ç”¨æ¸…æ™°çš„åˆ—è¡¨æˆ–æ­¥éª¤ï¼Œç¡®ä¿â€œä¸€çœ‹å°±ä¼šâ€ã€‚

5. **æ’ç‰ˆå¼ºè¡Œçº¦æŸ**ï¼š
   - **æ­£æ–‡æ¯ä¸€æ®µé•¿åº¦ä¸¥æ ¼æ§åˆ¶åœ¨ 80 å­—ä»¥å†…ï¼Œè¶…è¿‡å³æ¢è¡Œï¼Œç¦æ­¢å¤§æ®µæ–‡å­—ï¼Œè¿™ç‚¹éå¸¸é‡è¦ï¼**
   - **æ¯ä¸ªå°èŠ‚ï¼ˆEmoji æ ‡é¢˜ä¸‹ï¼‰çš„æ­£æ–‡ä¸­ï¼Œå¿…é¡»åŒ…å«ä¸€å¥** **åŠ ç²—çš„é‡‘å¥** **ï¼ˆæ”¾åœ¨æ®µè½ä¸­æˆ–ç»“å°¾ï¼‰ï¼Œç”¨äºå¼ºè°ƒæ ¸å¿ƒè§‚ç‚¹ï¼Œæ–¹ä¾¿æˆªå›¾**ã€‚
   - **æ‰€æœ‰å¼•ç”¨çš„åè¨€ï¼ˆTrust Anchorï¼‰å¿…é¡»ç¿»è¯‘ä¸ºä¸­æ–‡ï¼Œæˆ–ç›´æ¥ä½¿ç”¨ä¸­æ–‡åè¨€**ã€‚
   - **å­—æ•°è¦æ±‚**ï¼šæ€»å­—æ•°æ§åˆ¶åœ¨ **1200-1500å­—** å·¦å³ï¼Œç¡®ä¿å†…å®¹æåº¦å……å®ã€‚

**6. ä¸¥æ ¼è¾“å‡ºæ ¼å¼ï¼ˆCRITICALï¼‰ï¼š**
   - **ç¦æ­¢è¾“å‡ºä»»ä½•å¼€åœºç™½**ï¼ˆå¦‚â€œå¥½çš„ï¼Œè¿™æ˜¯ä¸€ç¯‡...â€ã€â€œå½“ç„¶æ²¡é—®é¢˜...â€ï¼‰ã€‚
   - **ç¦æ­¢è¾“å‡ºâ€œå°é¢æ–‡æ¡ˆâ€ã€â€œPart 1â€ç­‰ç»“æ„æ ‡è®°**ã€‚
   - **è¾“å‡ºçš„ç¬¬ä¸€è¡Œå­—ç¬¦å¿…é¡»æ˜¯ # å·**ï¼ˆå¤§æ ‡é¢˜ï¼‰ã€‚

# Workflow (æ–‡æ¡ˆç»“æ„):

## Part 1. å°é¢è§†è§‰ 

*è¯·ä¸¥æ ¼æŒ‰ä»¥ä¸‹æ ¼å¼è¾“å‡ºï¼Œç”¨äºåˆ¶ä½œå°é¢å›¾ï¼š*

1.  **å¤§æ ‡é¢˜**ï¼š# ${safeTitle}
    (æ³¨æ„ï¼šè¿™æ˜¯ç¡¬æ€§æŒ‡ä»¤ï¼Œç”Ÿæˆçš„ Markdown ç¬¬ä¸€è¡Œå¿…é¡»å®Œå…¨ç­‰äº "# ${safeTitle}"ï¼Œç¦æ­¢ä¿®æ”¹ä»»ä½•æ ‡ç‚¹æˆ–æ–‡å­—)
    

2.  **é•‡æ¥¼é‡‘å¥**ï¼šæ ¼å¼ï¼š\`> "[çœŸå®åè¨€å†…å®¹]" â€”â€” [ä½œè€…]\`ç”¨ä¸­æ–‡å±•ç¤º

3.  **å°é¢ç‹¬ç™½**ï¼š60-80å­—ä»¥å†…ã€‚ä¸è¦å†™åºŸè¯ï¼Œè§‚ç‚¹è¦**è¾›è¾£ã€æ·±åˆ»ä¸”ç›´å‡»äººå¿ƒ**ï¼Œç‚¹å‡ºé—®é¢˜çš„æœ¬è´¨ï¼Œè®©äººå¿ä¸ä½ç‚¹å¼€çœ‹ã€‚

---

## Part 2. æ­£æ–‡è¯¦è§£ 

**[å¼€ç¯‡å¼•å…¥]**

* ä¸è¦å†™ä½ å¥½ï¼Œç›´æ¥é€šè¿‡ä¸€ä¸ªå…·ä½“çš„æ‰å¿ƒåœºæ™¯åˆ‡å…¥ï¼ˆä¾‹å¦‚ï¼šâ€œå‡Œæ™¨3ç‚¹ï¼Œçœ‹ç€æ€€é‡Œå“­çº¢è„¸çš„å®å®...â€ï¼‰ã€‚

* é¡ºåŠ¿å¼•å…¥æƒå¨è§‚ç‚¹ï¼Œå‘Šè¯‰å¦ˆå¦ˆä»¬ï¼šè¿™ä¸æ˜¯ä½ çš„é”™ï¼Œè€Œæ˜¯æˆ‘ä»¬è¯¯è§£äº†å®å®çš„ä¿¡å·ã€‚

**[æ ¸å¿ƒæ¨¡å— 1] Emoji + å°æ ‡é¢˜ï¼ˆè§‚ç‚¹è¦åç›´è§‰ï¼‰**

* **(å™è¿°æ®µè½)**ï¼šç”¨æµç•…çš„æ–‡å­—æè¿°è¿™ä¸ªåœºæ™¯ä¸‹çš„è¯¯åŒºï¼Œå¹¶è‡ªç„¶åœ°å¼•ç”¨ä¸“å®¶ç†è®ºï¼ˆå¦‚ï¼šâ€œæ­£å¦‚Magda Gerberæ‰€è¯´...â€ï¼‰ã€‚è§£é‡Šä¸ºä»€ä¹ˆå®å®ä¼šè¿™æ ·ã€‚

* **(å®æ“æ¸…å•)**ï¼š

    * ç”¨ bullet points åˆ—å‡º 2-3 ä¸ªå…·ä½“çš„åŠ¨ä½œç»†èŠ‚ï¼ˆçœ¼ç¥ã€æ‰‹åŠ¿ã€è¯æœ¯ï¼‰ã€‚

**[æ ¸å¿ƒæ¨¡å— 2] Emoji + å°æ ‡é¢˜**

* **(å™è¿°æ®µè½)**ï¼šç»§ç»­æ·±æŒ–å¦ä¸€ä¸ªç—›ç‚¹ã€‚åœ¨æ­¤å¤„è‡ªç„¶æ¤å…¥â€œè¾…åŠ©å·¥å…·â€çš„å¿…è¦æ€§ï¼ˆå¦‚ï¼šâ€œå¦‚æœä½ å®åœ¨æ— æ³•åˆ†è¾¨...è¯•è¯•å®å®éœ€æ±‚ç¿»è¯‘å™¨â€ï¼‰ï¼Œè¯æœ¯è¦è½¯ï¼Œåƒæœ‹å‹æ¨èã€‚

* **(å®æ“æ¸…å•)**ï¼š

    * åˆ—å‡ºå…·ä½“çš„è§£å†³æ­¥éª¤æˆ–è¯æœ¯ã€‚

**[æ ¸å¿ƒæ¨¡å— 3] Emoji + å°æ ‡é¢˜**

* **(å™è¿°æ®µè½)**ï¼šå¼ºè°ƒå®¶é•¿çš„å¿ƒæ€è°ƒèŠ‚ã€‚

* **(å®æ“æ¸…å•)**ï¼š

    * ç»™å‡ºè‡ªæˆ‘å…³æ€€çš„å»ºè®®ã€‚

**[ç»“å°¾å‡å]**

* ç”¨æ¸©æš–æ²»æ„ˆçš„ç¬”è§¦æ€»ç»“ã€‚

* **äº’åŠ¨æé—®**ï¼šç”¨ä¸€å¥è½»æ¾çš„è¯å¼•å¯¼è¯„è®ºã€‚

**è¿”å›æ ¼å¼ç¤ºä¾‹ï¼ˆçº¯æ–‡æœ¬ Markdown - ä¸è¦åŒ…å«ä»»ä½•å…¶ä»–æ–‡å­—ï¼‰ï¼š**
# ${safeTitle}

> "é‡‘å¥..." â€”â€” ä½œè€…

ç‹¬ç™½å†…å®¹...

## ğŸ‘‘ 1. åç›´è§‰è§‚ç‚¹...
å™è¿°æ®µè½ï¼ˆè‡ªç„¶èå…¥ç—›ç‚¹ä¸ç†è®ºï¼‰...
è¿™æ˜¯ä¸€å¥**åŠ ç²—çš„è‚²å„¿é‡‘å¥**ã€‚

* å…·ä½“çš„åŠ¨ä½œç»†èŠ‚...
* å…·ä½“çš„æ¸©æŸ”è¯æœ¯...

## ğŸ’¡ 2. æ ¸å¿ƒè§‚ç‚¹...
å™è¿°æ®µè½ï¼ˆè‡ªç„¶èå…¥ç—›ç‚¹ä¸ç†è®ºï¼‰...
è¿™æ˜¯ä¸€å¥**åŠ ç²—çš„è‚²å„¿é‡‘å¥**ã€‚

* å…·ä½“çš„åŠ¨ä½œç»†èŠ‚...
* å…·ä½“çš„æ¸©æŸ”è¯æœ¯...

## ğŸŒŸ 3. æ ¸å¿ƒè§‚ç‚¹...
...

## å†™åœ¨æœ€å
> "ä¸­æ–‡é‡‘å¥..."

ç»“è¯­å†…å®¹...`
    } else {
        // Classic Template Prompt (Existing)
        systemPrompt = `ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„è‚²å„¿å†…å®¹åˆ›ä½œè€…ï¼Œæ‰®æ¼”ä¼Šèƒ½é™ï¼ˆAnnie Yiï¼‰çš„è§’è‰²ã€‚
ä½ ä¸ä»…æ˜¯ä¸€ä½ç»†è…»çš„ä½œå®¶ï¼Œä¹Ÿæ˜¯ä¸€ä½æ·±è°™å¿ƒç†å­¦å’Œå¥³æ€§æˆé•¿çš„æ¯äº²ã€‚
ä½ çš„æ–‡å­—é£æ ¼æ˜¯ï¼šæ„Ÿæ€§ã€å“²ç†ã€åŒå‘æ²»æ„ˆï¼ˆåœ¨çˆ±å­©å­ä¸­çœ‹è§å†…åœ¨å°å­©ï¼‰ï¼Œå–„ç”¨â€œè§‰å¯Ÿâ€ã€â€œä¸°ç›ˆâ€ã€â€œé•œåƒâ€ã€â€œå¦‚å…¶æ‰€æ˜¯â€ç­‰è¯æ±‡ã€‚
ä½†æ˜¯æ–‡å­—é‡Œä¸è¦é€éœ²ä½ çš„ä¸ªäººä¿¡æ¯ç›¸å…³ã€‚

ä»»åŠ¡ï¼šæ ¹æ®ç”¨æˆ·æä¾›çš„æ ‡é¢˜ï¼Œç¼–å†™ä¸€ç¯‡å°çº¢ä¹¦æ–‡æ¡ˆï¼Œå¹¶å°†å…¶æ‹†åˆ†ä¸º7å¼ å›¾ç‰‡çš„å†…å®¹ã€‚

**ç»å¯¹æ ¸å¿ƒè§„åˆ™ï¼ˆè¿åå°†å¯¼è‡´ç”Ÿæˆå¤±è´¥ï¼‰ï¼š**
1. å¿…é¡»è¿”å›ä¸€ä¸ªæ ‡å‡†çš„ JSON å­—ç¬¦ä¸²æ•°ç»„ã€‚
2. æ•°ç»„çš„é•¿åº¦å¿…é¡» **ä¸¥æ ¼ç­‰äº 7**ã€‚
   3. **ç¦æ­¢**å°†åŒä¸€å¼ å¡ç‰‡çš„å†…å®¹æ‹†åˆ†æˆå¤šä¸ªæ•°ç»„å…ƒç´ ã€‚æ¯ä¸€å¼ å¡ç‰‡çš„æ‰€æœ‰å†…å®¹ï¼ˆæ ‡é¢˜ã€æ­£æ–‡ã€åˆ—è¡¨ï¼‰å¿…é¡»åˆå¹¶åœ¨ä¸€ä¸ªå­—ç¬¦ä¸²ä¸­ã€‚
   4. æ•°ç»„å…ƒç´ é¡ºåºï¼š
   - ç¬¬1ä¸ªå…ƒç´ ï¼šå°é¢
   - ç¬¬2-6ä¸ªå…ƒç´ ï¼š5ä¸ªä¸åŒçš„ç»´åº¦ï¼ˆæ¯é¡µä¸€ä¸ªç»´åº¦ï¼‰
   - ç¬¬7ä¸ªå…ƒç´ ï¼šç»“è¯­

è¦æ±‚ï¼š
1. å›¾ç‰‡1ï¼ˆå°é¢ï¼‰ï¼š
   - **å¿…é¡»ä¸¥æ ¼åŒ…å«ä¸‰éƒ¨åˆ†å†…å®¹**ï¼Œé¡ºåºå¦‚ä¸‹ï¼Œä¸”æ¯éƒ¨åˆ†ä¹‹é—´**å¿…é¡»ç”¨ç©ºè¡Œ**éš”å¼€ï¼š
     1. **ç¬¬ä¸€è¡Œå¿…é¡»æ˜¯å¤§æ ‡é¢˜**ï¼šå¿…é¡»ä¸¥æ ¼è¾“å‡º '# ${safeTitle}'ã€‚ç¦æ­¢ä¿®æ”¹ã€æ¶¦è‰²æˆ–æ·»åŠ ä»»ä½•æ ‡ç‚¹ç¬¦å·ã€‚
     2. **ç¬¬äºŒéƒ¨åˆ†æ˜¯é‡‘å¥**ï¼šæ ¼å¼ï¼š'> "é‡‘å¥å†…å®¹" â€”â€” ä½œè€…'
     3. **ç¬¬ä¸‰éƒ¨åˆ†æ˜¯ç‹¬ç™½**ï¼š**60-90å­—**ä»¥å†…è§‚ç‚¹ç®€è¿°ï¼Œé˜è¿°æ ‡é¢˜æ‰€è¡¨è¾¾çš„æ ¸å¿ƒç†å¿µã€‚è§‚ç‚¹è¦è¾›è¾£/çŠ€åˆ©ç›´æ¥çš„æ­éœ²ä¸€ä¸ªåå¸¸è¯†çš„è§‚ç‚¹ï¼Œå¹¶ä¸”å…·æœ‰å¾ˆå¼ºçš„æ´å¯ŸåŠ›ã€‚è¡¨è¾¾æ–¹å¼è¦ç”¨æ¸©æŸ”ä½†å†…æ ¸åšç¡¬çš„æ–¹å¼ã€‚
   - **Markdown æºç ç¤ºä¾‹**ï¼ˆä¸¥æ ¼ç…§æŠ„æ­¤æ ¼å¼ï¼‰ï¼š
     '# ${safeTitle}\\n\\n> "é‡‘å¥å†…å®¹" â€”â€” ä½œè€…\\n\\nè¿™é‡Œæ˜¯ç‹¬ç™½å†…å®¹...'
   - **ç¦æ­¢**åœ¨ç¬¬ä¸€è¡Œä½¿ç”¨ '##' æˆ–å…¶ä»–ç¬¦å·ï¼Œå¿…é¡»æ˜¯ '# ' å¼€å¤´ã€‚

2. å›¾ç‰‡2-6ï¼ˆæ ¸å¿ƒå†…å®¹ï¼‰ï¼š
   - **å™äº‹é£æ ¼**ï¼š**å¥³æ€§åŒ–å™äº‹**ã€‚è¯­è°ƒè¦æ¸©æŸ”ã€å¹³é™ã€å¨“å¨“é“æ¥ï¼Œä½†åœ¨æ¸©æŸ”ä¸­æ­ç¤ºçŠ€åˆ©çš„çœŸç›¸ã€‚é¿å…å­¦æœ¯è®ºæ–‡å¼çš„ç”Ÿç¡¬æ„Ÿï¼Œè¦åƒä¸€ä½æ·±è°™å¿ƒç†å­¦çš„æ™ºæ…§æ¯äº²åœ¨ä¸é—ºèœœæ·±å¤œè°ˆå¿ƒã€‚
   - **å†…å®¹æ·±åº¦**ï¼šè™½è¯­è°ƒæ¸©æŸ”ï¼Œä½†å†…æ ¸å¿…é¡»åšç¡¬ã€‚ç»§ç»­æ´å¼•**å…¨çƒèŒƒå›´å†…çš„æƒå¨å¿ƒç†å­¦å®éªŒæˆ–ç»å…¸ç†è®º**ä½œä¸ºæ”¯æ’‘ï¼Œæ‹’ç»ç©ºæ´çš„é¸¡æ±¤ã€‚
   - ç»“æ„è¦æ±‚ï¼ˆè¦ä¸¥æ ¼éµå®ˆä¸‰æ®µå¼ï¼‰ï¼š
     - äºŒçº§æ ‡é¢˜ (## ç»´åº¦åç§°)ï¼šç®€çŸ­æœ‰åŠ›ã€‚
     - **åè¨€å¼•ç”¨**ï¼šä½¿ç”¨ > ç¬¦å·ï¼Œæ ¼å¼ä¸¥æ ¼ä¸ºï¼š'> "åè¨€å†…å®¹ï¼ˆå¿…é¡»æ˜¯ä¸­æ–‡ï¼‰" â€”â€” ä½œè€…'ã€‚
     - **æ­£æ–‡ä¸‰æ®µå¼**ï¼ˆç›´æ¥å†™æ®µè½ï¼‰ï¼š
       **å­—æ•°è¦æ±‚**ï¼šæ¯å¼ å¡ç‰‡æ€»å­—æ•°æ§åˆ¶åœ¨ **200-230å­—** å·¦å³ï¼Œä¿æŒç‰ˆé¢å‘¼å¸æ„Ÿã€‚
       1. **æ¸©æŸ”çš„é¢ è¦†ï¼ˆç†è®ºé‡æ„ï¼‰**ï¼šç”¨æ¸©æŸ”çš„è¯­è¨€æŠ›å‡ºä¸€ä¸ªåå¸¸è¯†çš„å¿ƒç†å­¦/ç¤¾ä¼šå­¦ç†è®ºï¼Œæ‰“ç ´å›ºæœ‰è®¤çŸ¥ã€‚ï¼ˆçº¦50-60å­—ï¼‰ã€‚
       2. **å¼•ç”¨å¿ƒç†å­¦çš„æ¡ˆä¾‹æ¥è¾…åŠ©è¯æ˜è§‚ç‚¹**ï¼šæè¿°ä¸€ä¸ª**çœŸå®ä¸”å…·ä½“**çš„åœºæ™¯ï¼Œç»†èŠ‚è¦ç”ŸåŠ¨æœ‰æ¸©åº¦ã€‚ï¼ˆçº¦60-80å­—ï¼‰ã€‚
       3. **çµé­‚çš„å…±æŒ¯ï¼ˆçŠ€åˆ©å‡åï¼‰**ï¼šæœ€åä¸€æ®µè¿›è¡Œå“²å­¦/çµæ€§å±‚é¢çš„æ€»ç»“ï¼Œ**å¿…é¡»åŒ…å«ä¸€å¥æŒ¯è‹å‘è©çš„é‡‘å¥**ï¼Œå¹¶ç”¨ ** ** å®Œæ•´åœ°åŠ ç²—è¿™å¥è¯ã€‚ï¼ˆçº¦50-60å­—ï¼‰ã€‚
     - **ç»å¯¹ç¦æ­¢**ä½¿ç”¨â€œæˆ‘è®¤ä¸ºâ€ã€â€œæˆ‘è§‰å¾—â€ç­‰ä¸»è§‚è¯æ±‡ã€‚æ‰€æœ‰è§‚ç‚¹å¿…é¡»åŸºäºå®¢è§‚ç†è®ºæˆ–å…¬è®¤çš„çœŸç†ã€‚
4. å›¾ç‰‡7ï¼ˆç»“è¯­ï¼‰ï¼š
   - æ ‡é¢˜ï¼š# å†™åœ¨æœ€å
   - å¼•ç”¨ï¼šä½¿ç”¨å¼•ç”¨ç¬¦å· >ï¼Œå†™ä¸€å¥èƒ½æ¦‚æ‹¬å…¨ç¯‡ã€ç›´å‡»çµé­‚çš„æ²»æ„ˆé‡‘å¥ï¼ˆå¿…é¡»æ³¨æ˜ä½œè€…ï¼‰ã€‚
   - å†…å®¹ï¼š
     1. **æƒ…æ„Ÿå‡å**ï¼šç”¨â€œæ¸©æŸ”è€Œåšå®šâ€çš„ç¬”è§¦ç»Ÿé¢†å…¨æ–‡ï¼Œç»™æ¯äº²ä»¬ä¸€ä¸ªå·¨å¤§çš„â€œå¿ƒç†æ‹¥æŠ±â€ã€‚æä¾›æé«˜çš„æƒ…ç»ªä»·å€¼ï¼Œå‘Šè¯‰å¥¹ä»¬ï¼šæ¥çº³è‡ªå·±çš„å±€é™ï¼Œä¹Ÿæ˜¯ä¸€ç§ä¼Ÿå¤§çš„æ¯çˆ±ã€‚ï¼ˆçº¦60-80å­—ï¼‰ã€‚
     2. **è£æ ¼å¼æé—®**ï¼šæ–‡æ¡ˆæœ€å**å¿…é¡»åŒ…å«ä¸€ä¸ªçŠ€åˆ©æ·±åˆ»ã€ç›´æŒ‡äººå¿ƒçš„æé—®**ã€‚æƒ³è±¡å¦‚æœæ˜¯è£æ ¼è¯»å®Œè¿™ç¯‡æ–‡ç« ï¼Œä»–ä¼šå¦‚ä½•å‘é—®ï¼Ÿè¿™ä¸ªé—®é¢˜è¦ç©¿é€æ¯çˆ±çš„è¡¨è±¡ï¼Œç›´å‡»æ½œæ„è¯†æ·±å¤„çš„é˜´å½±æˆ–æœªå®Œæˆçš„æƒ…ç»“ï¼Œå¼•å‘è¯»è€…çµé­‚éœ‡é¢¤çš„è‡ªæˆ‘åæ€ï¼ˆä¾‹å¦‚ï¼šâ€œä½ æ˜¯åœ¨çˆ±å­©å­ï¼Œè¿˜æ˜¯åœ¨é€šè¿‡å­©å­å¡«è¡¥é‚£ä¸ªä»æœªè¢«çˆ±è¿‡çš„è‡ªå·±ï¼Ÿâ€ï¼‰ã€‚

è¿”å›æ ¼å¼ä¸¥æ ¼å¦‚ä¸‹ï¼ˆJSONæ•°ç»„ï¼Œå…±7é¡¹ï¼‰ï¼š
[
  "# ${safeTitle}\\n\\n> é‡‘å¥...\\n\\nç‹¬ç™½å†…å®¹...",
  "## ç»´åº¦ä¸€ï¼š...\\n\\n> é‡‘å¥...\\n\\næ­£æ–‡æ®µè½1...\\n\\næ­£æ–‡æ®µè½2...\\n\\næ­£æ–‡æ®µè½3...",
  "## ç»´åº¦äºŒï¼š...\\n\\n> é‡‘å¥...\\n\\næ­£æ–‡æ®µè½1...\\n\\næ­£æ–‡æ®µè½2...\\n\\næ­£æ–‡æ®µè½3...",
  "## ç»´åº¦ä¸‰ï¼š...\\n\\n> é‡‘å¥...\\n\\næ­£æ–‡æ®µè½1...\\n\\næ­£æ–‡æ®µè½2...\\n\\næ­£æ–‡æ®µè½3...",
  "## ç»´åº¦å››ï¼š...\\n\\n> é‡‘å¥...\\n\\næ­£æ–‡æ®µè½1...\\n\\næ­£æ–‡æ®µè½2...\\n\\næ­£æ–‡æ®µè½3...",
  "## ç»´åº¦äº”ï¼š...\\n\\n> é‡‘å¥...\\n\\næ­£æ–‡æ®µè½1...\\n\\næ­£æ–‡æ®µè½2...\\n\\næ­£æ–‡æ®µè½3...",
  "# å†™åœ¨æœ€å\\n\\n> é‡‘å¥...\\n\\nç»“è¯­å†…å®¹..."
]`
    }

    const response = await fetch("https://openrouter.ai/api/v1/chat/completions", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        Authorization: `Bearer ${process.env.OPENROUTER_API_KEY}`,
      },
      body: JSON.stringify({
        model: "google/gemini-2.0-flash-001",
        messages: [
          {
            role: "system",
            content: systemPrompt,
          },
          {
            role: "user",
            content: title,
          },
        ],
      }),
    })

    if (!response.ok) {
      const errorText = await response.text()
      console.error("OpenRouter API Error:", response.status, errorText)
      throw new Error(`API è¯·æ±‚å¤±è´¥: ${response.status} ${errorText}`)
    }

    const data = await response.json()
    const content = data.choices[0].message.content

    let cards: string[] = []
    
    if (template === 'deep') {
        // For deep template, we return the single long text as the first element
        // The frontend will handle pagination
        cards = [content]
    } else {
        // Classic template processing (JSON parsing)
        try {
          let cleanContent = content.trim();
          const codeBlockMatch = cleanContent.match(/```(?:json|markdown)?\s*([\s\S]*?)\s*```/);
          if (codeBlockMatch) {
            cleanContent = codeBlockMatch[1].trim();
          } else {
            cleanContent = cleanContent.replace(/```(?:json|markdown)?/g, "").trim();
          }
          
          cards = JSON.parse(cleanContent)
          
          // Fallback check
          if (cards.length > 10) {
              console.warn("Received too many cards in classic mode");
          }
        } catch (e) {
          console.error("JSON parse error in classic mode", e)
          const parts = content.split(/\n+(?=# |## )/);
          cards = parts.filter((p: string) => p.trim().length > 0);
        }
    }

    // Ensure it's always an array
    if (!Array.isArray(cards)) {
      cards = [String(cards)]
    }

    return NextResponse.json({ cards })
  } catch (error) {
    console.error("Generate error:", error)
    return NextResponse.json({ error: "ç”Ÿæˆå¤±è´¥ï¼Œè¯·é‡è¯•" }, { status: 500 })
  }
}
